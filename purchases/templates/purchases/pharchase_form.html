{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="my-4 text-center">
    {% if purchase %}تعديل فاتورة شراء{% else %}فاتورة شراء جديدة{% endif %}
  </h2>
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="row">
          <div class="col-md-6 mb-3">
            {{ form.supplier.label_tag }}  
            {{ form.supplier }}  
            {{ form.supplier.errors }}
          </div>
          <div class="col-md-6 mb-3">
            {{ form.notes.label_tag }}  
            {{ form.notes }}  
          </div>
        </div>
        <hr>
        {{ formset.management_form }}
        <div id="items">
          {% for item in formset %}
          <div class="row align-items-end mb-2">
            <div class="col-md-4 mb-2">
              {{ item.product_unit.label_tag }} {{ item.product_unit }} {{ item.product_unit.errors }}
            </div>
            <div class="col-md-2 mb-2">
              {{ item.quantity.label_tag }} {{ item.quantity }} {{ item.quantity.errors }}
            </div>
            <div class="col-md-2 mb-2">
              {{ item.price.label_tag }} {{ item.price }} {{ item.price.errors }}
            </div>
            <div class="col-md-2 mb-2">
              <button type="button" class="btn btn-danger remove-item">×</button>
            </div>
            {{ item.id }} {{ item.DELETE }}
          </div>
          {% endfor %}
        </div>
        <button id="add-item" type="button" class="btn btn-outline-primary mb-3">إضافة بند</button>
        <div class="text-center">
          <button type="submit" class="btn btn-success">حفظ الفاتورة</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var addBtn      = document.getElementById('add-item');
    var itemsDiv    = document.getElementById('items');
    var totalInput  = document.querySelector('input[name="{{ formset.prefix }}-TOTAL_FORMS"]');
    if (!addBtn || !itemsDiv || !totalInput) return;

    addBtn.onclick = function() {
      var formCount  = parseInt(totalInput.value, 10);
      var firstRow   = itemsDiv.querySelector('.row');
      var newRow     = firstRow.cloneNode(true);

      // Update cloned fields
      Array.prototype.forEach.call(newRow.querySelectorAll('input, select'), function(field) {
        var name = field.name;
        if (!name) return;
        var newName = name.replace('-0-', '-' + formCount + '-');
        field.name = newName;
        field.id   = 'id_' + newName;
        if (field.type === 'checkbox') {
          field.checked = false;
        } else {
          field.value = '';
        }
      });

      // Increment total forms
      totalInput.value = formCount + 1;
      itemsDiv.appendChild(newRow);
    };

    // Delegate remove-button clicks
    itemsDiv.addEventListener('click', function(e) {
      if (!e.target.classList.contains('remove-item')) return;
      var row = e.target.closest('.row');
      var del = row.querySelector('input[type="checkbox"]');
      if (del) del.checked = true;
      row.style.display = 'none';
    });
  });
</script>
{% endblock %}
