{% extends "core/base.html" %}
{% block content %}
<div class="container mt-5">
    <h2>إنشاء عملية بيع جديدة</h2>
    <form method="post">
        {% csrf_token %}
        <div class="card p-3 mb-3">
            <h4>اسم العميل</h4>
            {{ invoice_form.as_p }}
        </div>
        <div class="card p-3 mb-3">
            <h4>المنتجات</h4>
            {{ formset.management_form }}
            <div id="product_list">
                {% for form in formset %}
                <div class="row mb-3 product-item">
                    <div class="col-md-5">
                        {{ form.product }}
                    </div>
                    <div class="col-md-2">
                        {{ form.sold_unit }}
                    </div>
                    <div class="col-md-2">
                        {{ form.quantity }}
                    </div>
                    <div class="col-md-3">
                        {{ form.price_per_unit }}
                    </div>
                    <div class="col-md-12 text-end mt-2">
                        <button type="button" class="btn btn-danger remove-product">Remove</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-product" class="btn btn-primary">بيع منتج جديدة</button>
        </div>
        <div class="card p-3 mb-3">
            <h4>الإجمالى <span id="total-price">0.00</span> جنيه مصرى</h4>
        </div>
        <button type="submit" class="btn btn-success">حفظ عملية البيع - الفاتورة</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Initialize Select2 on existing product select fields and bind to "select2:select" -->
<script>
$(document).ready(function(){
    $('.select-product').select2({
       placeholder: "اختر المنتج",
       allowClear: true,
       width: '100%'
    }).on("select2:select", function(e){
       // When a product is selected, trigger fetching its details.
       let row = $(this).closest(".product-item")[0];
       fetchProductDetails(this, row);
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let totalForms = document.querySelector("input[name='items-TOTAL_FORMS']");
    let productList = document.getElementById("product_list");
    let addProductButton = document.getElementById("add-product");
    let totalPriceField = document.getElementById("total-price");

    // Update overall invoice total by summing row totals.
    function updateTotal() {
        let total = 0;
        document.querySelectorAll(".product-item").forEach(item => {
            let quantityField = item.querySelector("input[name$='-quantity']");
            let priceField = item.querySelector(".price-field");
            let quantity = parseFloat(quantityField?.value) || 0;
            let price = parseFloat(priceField?.value) || 0;
            total += quantity * price;
        });
        totalPriceField.textContent = total.toFixed(2);
    }

    // Update price in a row based on the selected unit.
    function updateRowPrice(row) {
        let productField = row.querySelector("select.select-product");
        let unitSelect = row.querySelector("select.unit-select");
        let priceField = row.querySelector(".price-field");
        if (!productField.dataset.productInfo) return;
        let productData = JSON.parse(productField.dataset.productInfo);
        let selectedUnit = unitSelect.value; // either "base" or "big"
        let basePrice = parseFloat(productData.sell_price_base);
        if (selectedUnit === 'big') {
            let conversion = parseFloat(productData.units_in_big_unit) || 1;
            priceField.value = (basePrice * conversion).toFixed(2);
        } else {
            priceField.value = basePrice.toFixed(2);
        }
        updateTotal();
    }

    // Fetch product details from the server and store in the product field's dataset.
    function fetchProductDetails(productField, row) {
        fetch(`/seller/get-product-price/${productField.value}/`)
            .then(response => response.json())
            .then(data => {
                console.log("Fetched data:", data);
                productField.dataset.productInfo = JSON.stringify(data);
                let unitSelect = row.querySelector("select.unit-select");
                if (!data.big_unit) {
                    unitSelect.innerHTML = `<option value="base">الوحدة الاقل (${data.base_unit})</option>`;
                } else {
                    unitSelect.innerHTML = `<option value="base">الوحدة الاقل (${data.base_unit})</option>
                                             <option value="big">الوحدة الاكبر (${data.big_unit})</option>`;
                }
                updateRowPrice(row);
            })
            .catch(error => console.error("Error fetching product details:", error));
    }

    // Bind unit-select change event for a row.
    function bindUnitChange(row) {
        let unitSelect = row.querySelector("select.unit-select");
        unitSelect.addEventListener("change", function() {
            updateRowPrice(row);
        });
    }

    // Function to add a new product row.
    function addProductRow() {
        if (!totalForms) {
            console.error("Total forms field not found.");
            return;
        }
        let formNum = parseInt(totalForms.value);
        let templateRow = productList.children[0];
        // Destroy Select2 on the product field in the template row for a clean clone.
        $(templateRow).find("select.select-product").select2("destroy");
        let newForm = templateRow.cloneNode(true);
        // Reinitialize Select2 on the original template row.
        $(templateRow).find("select.select-product").select2({
            placeholder: "اختر المنتج",
            allowClear: true,
            width: '100%'
        });
        // Update cloned row's indices and clear its fields.
        newForm.innerHTML = newForm.innerHTML.replace(/items-\d+/g, `items-${formNum}`);
        newForm.querySelectorAll("input, select").forEach(el => {
            if (el.tagName.toLowerCase() === "select") {
                el.selectedIndex = 0;
            } else {
                el.value = "";
            }
        });
        productList.appendChild(newForm);
        totalForms.value = formNum + 1;

        let newProductField = newForm.querySelector("select.select-product");
        // Reinitialize Select2 on the new product field and bind to select2:select event.
        $(newProductField).select2({
            placeholder: "اختر المنتج",
            allowClear: true,
            width: '100%'
        }).on("select2:select", function(e) {
            console.log("Product selected in new row:", newProductField.value);
            fetchProductDetails(newProductField, newForm);
        });
        bindUnitChange(newForm);
        newForm.querySelector("input[name$='-quantity']").addEventListener("input", updateTotal);
        newForm.querySelector(".remove-product").addEventListener("click", function () {
            newForm.remove();
            updateTotal();
        });
    }

    addProductButton.addEventListener("click", addProductRow);

    // For existing rows, bind unit-select change events.
    document.querySelectorAll("select.unit-select").forEach(function(unitSelect) {
        let row = unitSelect.closest(".product-item");
        unitSelect.addEventListener("change", function() {
            updateRowPrice(row);
        });
    });
    // Bind quantity inputs and remove buttons for existing rows.
    document.querySelectorAll("input[name$='-quantity']").forEach(field => {
        field.addEventListener("input", updateTotal);
    });
    document.querySelectorAll(".remove-product").forEach(button => {
        button.addEventListener("click", function () {
            button.closest(".product-item").remove();
            updateTotal();
        });
    });
});
</script>
{% endblock %}
